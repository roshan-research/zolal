/* Backbone IndexedDb 0.0.13 @ 458e90 */
(function(e,t){typeof define=="function"&&define.amd?define(["backbone","underscore"],t):typeof exports=="object"?module.exports=t(require("backbone"),require("underscore")):e.returnExports=t(e.Backbone,e._)})(this,function(e,t){function n(){return((1+Math.random())*65536|0).toString(16).substring(1)}function r(){return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function i(e,n,r,i){this.schema=e,this.ready=n,this.error=null,this.transactions=[],this.db=null,this.nolog=r,this.onerror=i;var o=t.last(this.schema.migrations).version;this.nolog||s("opening database "+this.schema.id+" in version #"+o),this.dbRequest=indexedDB.open(this.schema.id,o),this.launchMigrationPath=function(n){var r=this.dbRequest.transaction,i=t.clone(e.migrations);this.migrate(r,i,n,{error:function(e){this.error="Database not up to date. "+n+" expected was "+o}.bind(this)})},this.dbRequest.onblocked=function(e){this.nolog||s("connection to database blocked")},this.dbRequest.onsuccess=function(e){this.db=e.target.result;var t=parseInt(this.db.version)||0,n=parseInt(o)||0;t===n?this.ready():t<n?this.launchMigrationPath(t):this.error="Database version is greater than current code "+t+" expected was "+n}.bind(this),this.dbRequest.onerror=function(e){this.error="Couldn't not connect to the database",this.nolog||s("Couldn't not connect to the database"),this.onerror()}.bind(this),this.dbRequest.onabort=function(e){this.error="Connection to the database aborted",this.nolog||s("Connection to the database aborted"),this.onerror()}.bind(this),this.dbRequest.onupgradeneeded=function(e){this.db=e.target.result;var t=e.newVersion,n=e.oldVersion;n>99999999999&&(n=0),this.nolog||s("onupgradeneeded = "+n+" => "+t),this.launchMigrationPath(n)}.bind(this)}function s(e){typeof window!="undefined"&&typeof window.console!="undefined"&&typeof window.console.log!="undefined"?window.console.log(e):console.log!=="undefined"&&console.log(e)}function o(e,n,r){this.driver=new i(e,this.ready.bind(this),r,this.error.bind(this)),this.started=!1,this.failed=!1,this.stack=[],this.version=t.last(e.migrations).version,this.next=n}function a(n,r,i){if(n=="closeall")return t.each(u,function(e){e.close()}),u={},e.$.Deferred().resolve();if(!r||!t.isObject(r.database))return e.ajaxSync(n,r,i);var s=r.database;u[s.id]&&u[s.id].version!=t.last(s.migrations).version&&(u[s.id].close(),delete u[s.id]);var a;typeof $!="undefined"&&$.Deferred&&(a=$.Deferred());var f=i.success;i.success=function(e){f&&f(e),a&&a.resolve(e),r.trigger("sync",r,e,i)};var l=i.error;i.error=function(e){l&&l(e),a&&a.reject(e),r.trigger("error",r,e,i)};var c=function(){u[s.id].execute([n,r,i])};return u[s.id]?c():u[s.id]=new o(s,c,s.nolog),a&&a.promise()}if(t(indexedDB).isUndefined())return;i.prototype={_track_transaction:function(e){function t(){var t=this.transactions.indexOf(e);t!==-1&&this.transactions.splice(t)}this.transactions.push(e),e.oncomplete=t.bind(this),e.onabort=t.bind(this),e.onerror=t.bind(this)},migrate:function(e,t,n,r){e.onerror=r.error,e.onabort=r.error,this.nolog||s("migrate begin version from #"+n);var i=this,o=t.shift();o&&(!n||n<o.version?(typeof o.before=="undefined"&&(o.before=function(e){e()}),typeof o.after=="undefined"&&(o.after=function(e){e()}),this.nolog||s("migrate begin before version #"+o.version),o.before(function(){this.nolog||s("migrate done before version #"+o.version),this.nolog||s("migrate begin migrate version #"+o.version),o.migrate(e,function(){this.nolog||s("migrate done migrate version #"+o.version),this.nolog||s("migrate begin after version #"+o.version),o.after(function(){this.nolog||s("migrate done after version #"+o.version),this.nolog||s("Migrated to "+o.version),t.length==0?this.nolog||(s("migrate setting transaction.oncomplete to finish version #"+o.version),e.oncomplete=function(){s("migrate done transaction.oncomplete version #"+o.version),s("Done migrating")}):(this.nolog||s("migrate end from version #"+n+" to "+o.version),i.migrate(e,t,n,r))}.bind(this))}.bind(this))}.bind(this))):(this.nolog||s("Skipping migration "+o.version),this.migrate(e,t,n,r)))},execute:function(e,t,n,r){this.nolog||s("execute : "+t+" on "+e+" for "+n.id);switch(t){case"create":this.create(e,n,r);break;case"read":n.id||n.cid?this.read(e,n,r):this.query(e,n,r);break;case"update":this.update(e,n,r);break;case"delete":n.id||n.cid?this.delete(e,n,r):this.clear(e,n,r);break;default:}},create:function(e,n,i){var s=this.db.transaction([e],"readwrite"),o=s.objectStore(e),u=n.toJSON(),a=t.result(n,"idAttribute"),f;u[a]===undefined&&!o.autoIncrement&&(u[a]=r()),s.onerror=function(e){i.error(e)},s.oncomplete=function(e){i.success(u)},o.keyPath?f=o.add(u):f=o.add(u,u[a])},update:function(e,n,i){var s=this.db.transaction([e],"readwrite"),o=s.objectStore(e),u=n.toJSON(),a=t.result(n,"idAttribute"),f;u[a]||(u[a]=r()),o.keyPath?f=o.put(u):f=o.put(u,u[a]),f.onerror=function(e){i.error(e)},s.oncomplete=function(e){i.success(u)}},read:function(e,n,r){var i=this.db.transaction([e],"readonly");this._track_transaction(i);var s=i.objectStore(e),o=n.toJSON(),u=t.result(n,"idAttribute"),a=null;if(o[u])a=s.get(o[u]);else if(r.index){var f=s.index(r.index.name);a=f.get(r.index.value)}else{var l=0;t.each(s.indexNames,function(e,n){n=s.index(e);if(typeof n.keyPath=="string"&&1>l)o[n.keyPath]!==undefined&&(a=n.get(o[n.keyPath]),l=1);else if(typeof n.keyPath=="object"&&n.keyPath.length>l){var r=!0,i=t.map(n.keyPath,function(e){return r=r&&o[e]!==undefined,o[e]});r&&(a=n.get(i),l=n.keyPath.length)}})}a?(a.onsuccess=function(e){e.target.result?r.success(e.target.result):r.error("Not Found")},a.onerror=function(){r.error("Not Found")}):r.error("Not Found")},"delete":function(e,n,r){var i=this.db.transaction([e],"readwrite"),s=i.objectStore(e),o=n.toJSON(),u=t.result(n,"idAttribute"),a=s.delete(o[u]);i.oncomplete=function(e){r.success(null)},a.onerror=function(e){r.error("Not Deleted")}},clear:function(e,t,n){var r=this.db.transaction([e],"readwrite"),i=r.objectStore(e),s=i.clear();s.onsuccess=function(e){n.success(null)},s.onerror=function(e){n.error("Not Cleared")}},query:function(e,n,r){var i=[],s=0,o=0,u=this.db.transaction([e],"readonly"),a=t.result(n.model.prototype,"idAttribute"),f=null,l=u.objectStore(e),c=null,h=null,p=null,d=null;r.conditions?t.each(l.indexNames,function(e){f||(c=l.index(e),r.conditions[c.keyPath]instanceof Array?(h=r.conditions[c.keyPath][0]>r.conditions[c.keyPath][1]?r.conditions[c.keyPath][1]:r.conditions[c.keyPath][0],p=r.conditions[c.keyPath][0]>r.conditions[c.keyPath][1]?r.conditions[c.keyPath][0]:r.conditions[c.keyPath][1],d=IDBKeyRange.bound(h,p,!0,!0),r.conditions[c.keyPath][0]>r.conditions[c.keyPath][1]?f=c.openCursor(d,window.IDBCursor.PREV||"prev"):f=c.openCursor(d,window.IDBCursor.NEXT||"next")):typeof r.conditions[c.keyPath]=="object"&&("$gt"in r.conditions[c.keyPath]||"$gte"in r.conditions[c.keyPath])?("$gt"in r.conditions[c.keyPath]?d=IDBKeyRange.lowerBound(r.conditions[c.keyPath].$gt,!0):d=IDBKeyRange.lowerBound(r.conditions[c.keyPath].$gte),f=c.openCursor(d,window.IDBCursor.NEXT||"next")):typeof r.conditions[c.keyPath]=="object"&&("$lt"in r.conditions[c.keyPath]||"$lte"in r.conditions[c.keyPath])?("$lt"in r.conditions[c.keyPath]?d=IDBKeyRange.upperBound(r.conditions[c.keyPath].$lt,!0):d=IDBKeyRange.upperBound(r.conditions[c.keyPath].$lte),f=c.openCursor(d,window.IDBCursor.NEXT||"next")):r.conditions[c.keyPath]!=undefined&&(d=IDBKeyRange.only(r.conditions[c.keyPath]),f=c.openCursor(d)))}):r.range?(h=r.range[0]>r.range[1]?r.range[1]:r.range[0],p=r.range[0]>r.range[1]?r.range[0]:r.range[1],d=IDBKeyRange.bound(h,p),r.range[0]>r.range[1]?f=l.openCursor(d,window.IDBCursor.PREV||"prev"):f=l.openCursor(d,window.IDBCursor.NEXT||"next")):f=l.openCursor(),typeof f=="undefined"||!f?r.error("No Cursor"):(f.onerror=function(e){r.error("readCursor error",e)},f.onsuccess=function(e){var t=e.target.result;if(!t)r.addIndividually||r.clear?n.trigger("reset"):r.success(i);else if(r.limit&&o>=r.limit)d&&r.conditions[c.keyPath]?t.continue(r.conditions[c.keyPath][1]+1):t.continue();else if(r.offset&&r.offset>s)s++,t.continue();else{if(r.addIndividually)n.add(t.value);else if(r.clear){var u=l.delete(t.value[a]);u.onsuccess=function(e){i.push(t.value)},u.onerror=function(e){i.push(t.value)}}else i.push(t.value);o++,t.continue()}})},close:function(){this.db&&this.db.close()}},o.prototype={ready:function(){this.started=!0,t.each(this.stack,function(e){this.execute(e)}.bind(this)),this.stack=[],this.next()},error:function(){this.failed=!0,t.each(this.stack,function(e){this.execute(e)}.bind(this)),this.stack=[],this.next()},execute:function(e){this.started?this.driver.execute(e[2].storeName||e[1].storeName,e[0],e[1],e[2]):this.failed?e[2].error():this.stack.push(e)},close:function(){this.driver.close()}};var u={};return e.ajaxSync=e.sync,e.sync=a,{sync:a,debugLog:s}});
